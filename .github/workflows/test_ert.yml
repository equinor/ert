on:
  workflow_call:
    inputs:
      os:
        type: string
      python-version:
        type: string
      test-type:
        type: string
      select-string:
        type: string
        default: '""'

env:
  ERT_SHOW_BACKTRACE: 1
  ERT_PYTEST_ARGS: '-m ${{ inputs.select-string }} --cov=ert --cov=everest --cov=_ert --cov-report=xml:cov_main.xml --junit-xml=junit.xml -o junit_family=legacy -v --durations=25 --benchmark-disable'
  UV_FROZEN: true
  OMP_NUM_THREADS: 1

jobs:
  tests-ert:
    name: Run ert tests
    runs-on: ${{ inputs.os }}
    timeout-minutes: 30
    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0
        submodules: true
        lfs: true

    - uses: ./.github/actions/install_dependencies_qt
      with:
        os: ${{ inputs.os }}

    - uses: actions/setup-python@v5
      id: setup_python
      with:
        python-version: ${{ inputs.python-version }}

    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        python-version: ${{ inputs.python-version }}

    - name: Install ert
      run: |
        uv sync --extra dev

    - name: Fqdn tests
      if: inputs.test-type == 'fqdn-test'
      run: |
        uv run pytest -svv --durations=0 tests/ert/fqdn_test
