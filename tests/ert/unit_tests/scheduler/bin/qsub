#!/usr/bin/env bash
set -e

name="STDIN"

jobid="test${RANDOM}.localhost"
jobdir="${PYTEST_TMP_PATH:-.}/mock_jobs/${jobid}"
mkdir -p "${jobdir}"

job_env_file="${jobdir}/env"
touch $job_env_file

while getopts "N:r:l:o:e:q:A:" opt
do
    case "$opt" in
        N)
            name=$OPTARG
            ;;
        r)
            ;;
        o)
            ;;
        e)
            ;;
        l)
            resource=$OPTARG
            echo $resource >> $job_env_file
            echo $resource >> "${jobdir}/resource_requirement"
            ;;
        q)
            ;;
        A)
            ;;
        *)
            echo "Unprocessed option ${opt}"
            ;;
    esac
done
shift $((OPTIND-1))


cat <&0 > "${jobdir}/script"
echo "$name" > "${jobdir}/name"

num_cpu=$(echo $resource | sed 's/.*ncpus=\([[:digit:]]*\).*/\1/')

[ -n $num_cpu ] && echo "export OMP_NUM_THREADS=$num_cpu" >> $job_env_file
[ -n $num_cpu ] && echo "export NCPUS=$num_cpu" >> $job_env_file

bash "$(dirname $0)/runner" "${jobdir}" >/dev/null 2>/dev/null &
disown

echo "$jobid"
