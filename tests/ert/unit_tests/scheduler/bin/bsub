#!/usr/bin/env bash
set -e

name="STDIN"

jobid="${RANDOM}"
jobdir="${PYTEST_TMP_PATH:-.}/mock_jobs/${jobid}"
mkdir -p "${jobdir}"
command_invocation_file="${jobdir}/complete_command_invocation"
echo "$0 $@" > "$command_invocation_file"

while getopts "o:e:J:q:R:n:P:" opt
do
    case "$opt" in
        o)
            stdout=$OPTARG
            ;;
        e)
            stderr=$OPTARG
            ;;
        J)
            name=$OPTARG
            ;;
        q)
            queue=$OPTARG
            ;;
        n)
            num_cpu=$OPTARG
            ;;
        R)
            resource_requirement=$OPTARG
            ;;
        P)
            project_code=$OPTARG
            ;;
        *)
            echo "Unprocessed option ${opt}"
            ;;
    esac
done
shift $((OPTIND-1))

job_env_file="${jobdir}/env"

echo $@ > "${jobdir}/script"
echo "$name" > "${jobdir}/name"
echo "$resource_requirement" > "${jobdir}/resource_requirement"
touch $job_env_file

[ -n $num_cpu ] && echo "export LSB_MAX_NUM_PROCESSORS=$num_cpu" >> $job_env_file

[ -z $stdout ] && stdout="/dev/null"
[ -z $stderr ] && stderr="/dev/null"

bash "$(dirname $0)/lsfrunner" "${jobdir}" >$stdout 2>$stderr &
disown

echo "Job <$jobid> is submitted to default queue <normal>."
